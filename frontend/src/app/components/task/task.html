<div class="page">
  <div class="card">

   <div class="header">
    <h2>My Tasks</h2>

    <div class="session" *ngIf="username">
      {{ username }} 
      <span *ngIf="previousLastLogin">
        | Last Login: {{ previousLastLogin | date:'dd MMM yyyy HH:mm' }}
      </span>
      <button (click)="logout()">Logout</button>
    </div>
  </div>
    <!-- Add/Edit Task Form -->
    <form [formGroup]="taskForm" (ngSubmit)="addOrUpdateTask()" class="task-form">
      <input type="text" placeholder="Task title" formControlName="title" />
      <textarea placeholder="Description" formControlName="description"></textarea>
      <div class="form-row">
        <select formControlName="priority">
          <option value="LOW">Low</option>
          <option value="MEDIUM">Medium</option>
          <option value="HIGH">High</option>
        </select>
        <input type="date" formControlName="dueDate" />
      </div>
      <button type="submit" class="submit-btn">
        {{ isEditing ? 'Update Task' : 'Add Task' }}
      </button>
    </form>

    <!-- Filters -->
    <div class="filters">
      <button (click)="setFilter('ALL')" [class.active]="filterSubject.value==='ALL'">All</button>
      <button (click)="setFilter('OPEN')" [class.active]="filterSubject.value==='OPEN'">Open</button>
      <button (click)="setFilter('IN_PROGRESS')" [class.active]="filterSubject.value==='IN_PROGRESS'">In Progress</button>
      <button (click)="setFilter('CLOSED')" [class.active]="filterSubject.value==='CLOSED'">Closed</button>
    </div>

    <!-- Task List -->
    <div class="task-list-container">
      <ul class="task-list">
        <li *ngFor="let task of tasks$ | async" class="task-card" [ngClass]="task.status.toLowerCase()">

          <!-- Task Info -->
          <div class="task-info">
            <h4>{{ task.title }}</h4>
            <p>{{ task.description }}</p>
            <div class="task-meta">
              <span class="priority {{ task.priority.toLowerCase() }}">{{ task.priority }}</span>
              <span class="due-date">Due: {{ task.dueDate | date:'dd MMM yyyy' }}</span>
            </div>
          </div>

          <!-- Actions -->
          <div class="actions">
            <!-- Status Button -->
            <button
              class="status-btn"
              [ngClass]="task.status.toLowerCase()"
              (click)="toggleStatus(task)">
              {{ task.status === 'OPEN' ? 'In Progress' : task.status === 'IN_PROGRESS' ? 'Close' : 'Reopen' }}
            </button>

            <!-- Edit Button -->
            <button class="edit-btn" (click)="editTask(task)">
              Edit
            </button>

            <!-- Delete Button -->
            <button class="delete-btn" (click)="deleteTask(task.id)">
              Delete
            </button>
          </div>
        </li>
      </ul>
    </div>

  </div>

  <!-- Pagination -->
  <div class="pagination">
    <button (click)="prevPage()" [disabled]="page === 0">Prev</button>
    <span>Page {{ page + 1 }} of {{ totalPages }}</span>
    <button (click)="nextPage()" [disabled]="page + 1 >= totalPages">Next</button>
  </div>
</div>